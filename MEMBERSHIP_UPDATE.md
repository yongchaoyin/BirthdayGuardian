# ä¼šå‘˜åŠŸèƒ½è¯´æ˜

## ä¼šå‘˜ä½“ç³»

### å…è´¹ç”¨æˆ·ï¼ˆæ¸©é¦¨ä½“éªŒï¼‰
- **å®ˆæŠ¤åé¢**: 3 ä½äº²å‹
- **æé†’æ–¹å¼**:
  - âœ… å¾®ä¿¡å°ç¨‹åºé€šçŸ¥
  - âœ… é‚®ä»¶æé†’
- **è´¹ç”¨**: å…è´¹

### VIPä¼šå‘˜ï¼ˆå®ˆæŠ¤ç¤¼é‡ï¼‰
- **å®ˆæŠ¤åé¢**: 20 ä½äº²å‹
- **æé†’æ–¹å¼**:
  - âœ… å¾®ä¿¡å°ç¨‹åºé€šçŸ¥
  - âœ… é‚®ä»¶æé†’
  - âœ… çŸ­ä¿¡æé†’ï¼ˆç”Ÿæ—¥å½“å¤©ï¼‰
- **è´¹ç”¨**: Â¥10/å¹´
- **æœ‰æ•ˆæœŸ**: 1 å¹´

## æé†’æœºåˆ¶è¯´æ˜

### 1. å°ç¨‹åºé€šçŸ¥
- **é€‚ç”¨äººç¾¤**: æ‰€æœ‰ç”¨æˆ·
- **é€šçŸ¥æ—¶æœº**: æå‰ N å¤©ï¼ˆç”¨æˆ·è‡ªå®šä¹‰ï¼‰
- **é€šçŸ¥æ–¹å¼**: å¾®ä¿¡å°ç¨‹åºè®¢é˜…æ¶ˆæ¯
- **å®ç°è¯´æ˜**:
  - ç”¨æˆ·éœ€åœ¨å°ç¨‹åºå†…æˆæƒè®¢é˜…æ¶ˆæ¯
  - æ”¯æŒä¸€æ¬¡æ€§è®¢é˜…å’Œé•¿æœŸè®¢é˜…ï¼ˆéœ€è¦ç”¨æˆ·æ‰‹åŠ¨æˆæƒï¼‰

### 2. é‚®ä»¶æé†’
- **é€‚ç”¨äººç¾¤**: æ‰€æœ‰ç”¨æˆ·
- **é€šçŸ¥æ—¶æœº**: æå‰ N å¤©ï¼ˆç”¨æˆ·è‡ªå®šä¹‰ï¼‰
- **é€šçŸ¥æ–¹å¼**: ç³»ç»Ÿè‡ªåŠ¨å‘é€é‚®ä»¶
- **å†…å®¹**: æš–å¿ƒæ–‡æ¡ˆï¼ŒåŒ…å«ç”Ÿæ—¥äººå§“åã€æ—¥æœŸç­‰ä¿¡æ¯

### 3. çŸ­ä¿¡æé†’
- **é€‚ç”¨äººç¾¤**: ä»… VIP ä¼šå‘˜
- **é€šçŸ¥æ—¶æœº**: ç”Ÿæ—¥å½“å¤©
- **é€šçŸ¥æ–¹å¼**: å‘é€çŸ­ä¿¡åˆ°è§’è‰²è”ç³»ç”µè¯
- **å†…å®¹**: æ ¹æ®ç”¨æˆ·å¡«å†™çš„å¤‡æ³¨å†…å®¹å‘é€ç¥ç¦çŸ­ä¿¡

## å°ç¨‹åºè®¢é˜…æ¶ˆæ¯å®ç°

### è®¢é˜…æ¶ˆæ¯æ¨¡æ¿

éœ€è¦åœ¨å¾®ä¿¡å°ç¨‹åºåå°ç”³è¯·ä»¥ä¸‹è®¢é˜…æ¶ˆæ¯æ¨¡æ¿ï¼š

**æ¨¡æ¿ 1ï¼šç”Ÿæ—¥æé†’**
```
è§’è‰²å§“åï¼š{{thing1.DATA}}
ç”Ÿæ—¥æ—¥æœŸï¼š{{date2.DATA}}
æå‰å¤©æ•°ï¼š{{number3.DATA}}
æ¸©é¦¨æç¤ºï¼š{{thing4.DATA}}
```

**æ¨¡æ¿ 2ï¼šç”Ÿæ—¥å½“å¤©ç¥ç¦**
```
è§’è‰²å§“åï¼š{{thing1.DATA}}
ç¥ç¦è¯­ï¼š{{thing2.DATA}}
```

### è®¢é˜…æµç¨‹

1. **ç”¨æˆ·æˆæƒ**
   - ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨æˆ–æ·»åŠ ç”Ÿæ—¥æ—¶ï¼Œè¯·æ±‚è®¢é˜…æ¶ˆæ¯æƒé™
   - ç”¨æˆ·åŒæ„åï¼Œå¯æ¥æ”¶é€šçŸ¥

2. **å‘é€é€šçŸ¥**
   - åç«¯å®šæ—¶ä»»åŠ¡æ£€æŸ¥ç”Ÿæ—¥
   - è°ƒç”¨å¾®ä¿¡ API å‘é€è®¢é˜…æ¶ˆæ¯
   - è®°å½•å‘é€æ—¥å¿—

### å°ç¨‹åºç«¯å®ç°

```javascript
// è¯·æ±‚è®¢é˜…æ¶ˆæ¯æˆæƒ
wx.requestSubscribeMessage({
  tmplIds: ['template-id-1', 'template-id-2'],
  success: (res) => {
    // ç”¨æˆ·åŒæ„æˆæƒ
    console.log('è®¢é˜…æˆåŠŸ', res)
  },
  fail: (err) => {
    // ç”¨æˆ·æ‹’ç»æˆæƒ
    console.log('è®¢é˜…å¤±è´¥', err)
  }
})
```

### åç«¯å®ç°

éœ€è¦åœ¨ `WeChatTemplateService` ä¸­æ·»åŠ å‘é€å°ç¨‹åºè®¢é˜…æ¶ˆæ¯çš„æ–¹æ³•ï¼š

```java
public boolean sendMiniprogramSubscribeMessage(
    User user,
    BirthdayRole role,
    LocalDate upcomingBirthday,
    long daysUntilBirthday
) {
    // è·å–ç”¨æˆ·çš„ openid
    UserWechat userWechat = userWechatService.getByUserId(user.getId());

    // æ„å»ºè®¢é˜…æ¶ˆæ¯
    WxMaSubscribeMessage message = WxMaSubscribeMessage.builder()
        .toUser(userWechat.getOpenid())
        .templateId("your-template-id")
        .page("pages/birthdays/list")
        .build();

    // æ·»åŠ æ•°æ®
    message.addData(new WxMaSubscribeMessage.Data("thing1", role.getRoleName()));
    message.addData(new WxMaSubscribeMessage.Data("date2", upcomingBirthday.toString()));
    message.addData(new WxMaSubscribeMessage.Data("number3", String.valueOf(daysUntilBirthday)));
    message.addData(new WxMaSubscribeMessage.Data("thing4", "è®°å¾—å‡†å¤‡ç¤¼ç‰©å“¦~"));

    // å‘é€æ¶ˆæ¯
    try {
        wxMaService.getMsgService().sendSubscribeMsg(message);
        return true;
    } catch (WxErrorException e) {
        logger.error("å‘é€å°ç¨‹åºè®¢é˜…æ¶ˆæ¯å¤±è´¥", e);
        return false;
    }
}
```

## ä¼šå‘˜è®¢é˜…åŠŸèƒ½

### æ”¯ä»˜æ–¹å¼

æ¨èä½¿ç”¨å¾®ä¿¡æ”¯ä»˜ï¼š

1. **å¾®ä¿¡æ”¯ä»˜é…ç½®**
   ```yaml
   wechat:
     pay:
       app-id: your-appid
       mch-id: your-mch-id
       mch-key: your-mch-key
       notify-url: https://your-domain.com/api/pay/notify
   ```

2. **æ”¯ä»˜æµç¨‹**
   - ç”¨æˆ·åœ¨å°ç¨‹åºä¸­é€‰æ‹©å‡çº§ VIP
   - è°ƒç”¨åç«¯åˆ›å»ºè®¢å•
   - åç«¯è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ç»Ÿä¸€ä¸‹å• API
   - è¿”å›æ”¯ä»˜å‚æ•°ç»™å°ç¨‹åº
   - å°ç¨‹åºè°ƒç”¨ `wx.requestPayment` å‘èµ·æ”¯ä»˜
   - æ”¯ä»˜æˆåŠŸåå›è°ƒé€šçŸ¥åç«¯
   - åç«¯æ›´æ–°ç”¨æˆ·ä¼šå‘˜çŠ¶æ€

### è®¢å•ç®¡ç†

å»ºè®®æ·»åŠ è®¢å•è¡¨ï¼š

```sql
CREATE TABLE `order` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `order_no` VARCHAR(64) NOT NULL COMMENT 'è®¢å•å·',
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `product_type` VARCHAR(20) NOT NULL COMMENT 'äº§å“ç±»å‹ï¼šVIP',
  `amount` DECIMAL(10,2) NOT NULL COMMENT 'é‡‘é¢',
  `status` VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT 'çŠ¶æ€ï¼šPENDING/PAID/CANCELLED',
  `pay_time` DATETIME DEFAULT NULL COMMENT 'æ”¯ä»˜æ—¶é—´',
  `transaction_id` VARCHAR(64) DEFAULT NULL COMMENT 'å¾®ä¿¡æ”¯ä»˜äº¤æ˜“å·',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•è¡¨';
```

### VIP ç»­è´¹æé†’

ç³»ç»Ÿåº”åœ¨ VIP åˆ°æœŸå‰æé†’ç”¨æˆ·ç»­è´¹ï¼š

- **æå‰ 7 å¤©**: å‘é€é‚®ä»¶å’Œå°ç¨‹åºé€šçŸ¥æé†’å³å°†åˆ°æœŸ
- **åˆ°æœŸå½“å¤©**: è‡ªåŠ¨é™çº§ä¸ºå…è´¹ç”¨æˆ·
- **åˆ°æœŸå**: ä¿ç•™æ‰€æœ‰æ•°æ®ï¼Œä½†åŠŸèƒ½é™çº§

## çŸ­ä¿¡åŠŸèƒ½è¯´æ˜

### çŸ­ä¿¡æœåŠ¡é…ç½®

```yaml
sms:
  config:
    config-type: YAML
    is-print: false
  blends:
    default:
      supplier: alibaba  # æˆ–ä½¿ç”¨å…¶ä»–çŸ­ä¿¡æœåŠ¡å•†
      access-key-id: ${SMS_ACCESS_KEY}
      access-key-secret: ${SMS_ACCESS_SECRET}
      template-id: ${SMS_TEMPLATE_ID}
      template-name: content
      signature: ç”Ÿæ—¥å®ˆæŠ¤è€…
      region-id: cn-hangzhou
```

### çŸ­ä¿¡æ¨¡æ¿ç¤ºä¾‹

```
ã€ç”Ÿæ—¥å®ˆæŠ¤è€…ã€‘{å¤‡æ³¨å†…å®¹}ã€‚ä»Šå¤©æ˜¯{è§’è‰²å§“å}çš„ç”Ÿæ—¥ï¼Œç¥TAç”Ÿæ—¥å¿«ä¹ï¼
```

### çŸ­ä¿¡å‘é€é€»è¾‘

1. ç³»ç»Ÿå®šæ—¶ä»»åŠ¡æ£€æŸ¥ä»Šå¤©æ˜¯å¦æœ‰ç”Ÿæ—¥
2. æ£€æŸ¥ï¿½ï¿½æˆ·æ˜¯å¦ä¸º VIP
3. æ£€æŸ¥è§’è‰²æ˜¯å¦å¡«å†™äº†è”ç³»ç”µè¯
4. å‘é€çŸ­ä¿¡åˆ°è§’è‰²çš„è”ç³»ç”µè¯
5. è®°å½•å‘é€æ—¥å¿—

## æ•°æ®åº“å˜æ›´

æ— éœ€é¢å¤–å˜æ›´ï¼Œç°æœ‰è¡¨ç»“æ„å·²æ”¯æŒï¼š

- `user` è¡¨çš„ `membership_level` å’Œ `vip_expire_time` å­—æ®µ
- `birthday_role` è¡¨çš„ `role_phone` å­—æ®µ
- `notification_log` è¡¨è®°å½•æ‰€æœ‰é€šçŸ¥æ—¥å¿—

## å°ç¨‹åºé¡µé¢è°ƒæ•´

### 1. ä¼šå‘˜ä¸­å¿ƒé¡µé¢

æ·»åŠ ä¼šå‘˜å‡çº§å…¥å£ï¼š

```xml
<view class="vip-upgrade" wx:if="{{membershipLevel === 'FREE'}}">
  <button class="btn-upgrade" bindtap="handleUpgrade">
    <text class="upgrade-icon">ğŸ‘‘</text>
    <view class="upgrade-info">
      <text class="upgrade-title">å‡çº§VIPä¼šå‘˜</text>
      <text class="upgrade-price">ä»…éœ€ Â¥10/å¹´</text>
    </view>
  </button>

  <view class="vip-benefits">
    <text class="benefits-title">VIPç‰¹æƒ</text>
    <view class="benefit-item">
      <text class="benefit-icon">âœ…</text>
      <text class="benefit-text">å®ˆæŠ¤20ä½äº²å‹</text>
    </view>
    <view class="benefit-item">
      <text class="benefit-icon">âœ…</text>
      <text class="benefit-text">ç”Ÿæ—¥å½“å¤©çŸ­ä¿¡æé†’</text>
    </view>
    <view class="benefit-item">
      <text class="benefit-icon">âœ…</text>
      <text class="benefit-text">æ‰€æœ‰å…è´¹åŠŸèƒ½</text>
    </view>
  </view>
</view>
```

### 2. æ”¯ä»˜é¡µé¢

åˆ›å»ºæ”¯ä»˜é¡µé¢ `pages/pay/pay`:

```javascript
// pages/pay/pay.js
Page({
  data: {
    productType: 'VIP',
    price: 10,
    duration: '1å¹´'
  },

  handlePay() {
    // è°ƒç”¨åç«¯åˆ›å»ºè®¢å•
    wx.request({
      url: `${app.globalData.apiBase}/api/order/create`,
      method: 'POST',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      data: {
        productType: 'VIP'
      },
      success: (res) => {
        if (res.data.code === 200) {
          // å‘èµ·å¾®ä¿¡æ”¯ä»˜
          wx.requestPayment({
            ...res.data.data,
            success: () => {
              wx.showToast({ title: 'æ”¯ä»˜æˆåŠŸ', icon: 'success' })
              setTimeout(() => {
                wx.navigateBack()
              }, 1500)
            },
            fail: (err) => {
              wx.showToast({ title: 'æ”¯ä»˜å¤±è´¥', icon: 'none' })
            }
          })
        }
      }
    })
  }
})
```

## å®ç°ä¼˜å…ˆçº§

### ç¬¬ä¸€é˜¶æ®µï¼ˆå·²å®Œæˆï¼‰
- âœ… åŸºç¡€ä¼šå‘˜ä½“ç³»
- âœ… åé¢é™åˆ¶
- âœ… é‚®ä»¶æé†’
- âœ… çŸ­ä¿¡æé†’ï¼ˆVIPï¼‰

### ç¬¬äºŒé˜¶æ®µï¼ˆå»ºè®®å®ç°ï¼‰
- ğŸ“‹ å°ç¨‹åºè®¢é˜…æ¶ˆæ¯
- ğŸ“‹ å¾®ä¿¡æ”¯ä»˜é›†æˆ
- ğŸ“‹ è®¢å•ç®¡ç†
- ğŸ“‹ VIP ç»­è´¹æé†’

### ç¬¬ä¸‰é˜¶æ®µï¼ˆå¯é€‰ï¼‰
- ğŸ“‹ æ”¯ä»˜ç»Ÿè®¡
- ğŸ“‹ æ”¶å…¥æŠ¥è¡¨
- ğŸ“‹ ä¼˜æƒ åˆ¸ç³»ç»Ÿ
- ğŸ“‹ ä¼šå‘˜ç­‰çº§æ‰©å±•

## æŠ€æœ¯æ”¯æŒ

å¦‚éœ€å®ç°æ”¯ä»˜åŠŸèƒ½æˆ–è®¢é˜…æ¶ˆæ¯ï¼Œè¯·å‚è€ƒï¼š

- [å¾®ä¿¡æ”¯ä»˜å¼€å‘æ–‡æ¡£](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [å°ç¨‹åºè®¢é˜…æ¶ˆæ¯](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)
- [å¾®ä¿¡æ”¯ä»˜å°ç¨‹åºæ¥å…¥](https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_8_1.shtml)

è”ç³»æ–¹å¼ï¼š
- é‚®ç®±ï¼šyinyc0925@outlook.com
